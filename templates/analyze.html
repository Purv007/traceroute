{% extends "base.html" %}
{% block content %}
<h2 class="title">Analysis • {{ scenario.upper() }}</h2>
<p class="subtitle">Input: {{ msg_len }} bytes • Repeat: {{ repeat }} • Source: {{ src_label }}</p>

<div class="grid lg:grid-cols-2 gap-6">
  <div class="panel">
    <div class="panel-title">Algorithms</div>
    <div class="overflow-x-auto">
      <table class="tbl">
        <thead>
          <tr>
            <th>Algorithm</th>
            <th class="t-right">AEAD</th>
            <th class="t-right">Mean (ms)</th>
            <th class="t-right">p95 (ms)</th>
          </tr>
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            <td>
              {{ r.algo }} {{ r.variant }}
              {% if r.nonce_reuse %}
                <span class="badge" title="Nonce reuse detected in this run">⚠ nonce-reuse</span>
              {% endif %}
            </td>
            <td class="t-right">{{ "Yes" if r.aead else "No" }}</td>
            <td class="t-right">{{ "%.4f"|format(r.mean_ms) }}</td>
            <td class="t-right">{{ "%.4f"|format(r.p95_ms) }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Performance chart</div>
    <canvas id="chart" height="180"></canvas>
  </div>
</div>

{% if lint %}
<div class="panel mt-6">
  <div class="panel-title">AEAD Misuse Linter</div>
  <ul class="list-disc ml-6 text-sm">
    {% for w in lint.warnings %}
      <li>{{ w }}</li>
    {% endfor %}
  </ul>

  <details class="mt-3">
    <summary class="cursor-pointer text-sm text-slate-300">Per-algorithm details</summary>
    <div class="grid md:grid-cols-2 gap-3 mt-3">
      {% for algo, msgs in lint.per_algo.items() %}
      <div class="card">
        <div class="font-mono text-xs mb-1">{{ algo }}</div>
        <ul class="list-disc ml-5 text-sm">
          {% for m in msgs %}
            <li>{{ m }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endfor %}
    </div>
  </details>
</div>
{% endif %}

<div class="panel mt-6">
  <div class="panel-title">Ciphertext previews (Base64)</div>
  <div class="grid md:grid-cols-2 gap-3">
    {% for r in rows %}
      <div class="card">
        <div class="flex items-center justify-between mb-1">
          <div class="font-medium">{{ r.algo }} {{ r.variant }}</div>
          <span class="badge">{{ "AEAD" if r.aead else "Enc+MAC" }}</span>
        </div>
        <div class="mono small break-all">{{ r.preview }}</div>
      </div>
    {% endfor %}
  </div>
</div>

<a href="{{ url_for('index') }}" class="btn-secondary mt-6">← Back</a>

{# --------- Data blob (no Jinja inside JS anymore) ---------- #}
<script id="rows-json" type="application/json">
{{ rows|default([])|tojson }}
</script>

{# Chart.js (fallback include) #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Parse JSON data from the script tag
  let rows = [];
  try {
    const el = document.getElementById('rows-json');
    rows = JSON.parse(el?.textContent || '[]');
  } catch (e) {
    rows = [];
  }

  const labels = rows.map(r => `${r.algo} ${r.variant}`);
  const mean   = rows.map(r => r.mean_ms);
  const p95    = rows.map(r => r.p95_ms);

  const ctx = document.getElementById('chart').getContext('2d');

  if (rows.length > 0) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Mean (ms)', data: mean },
          { label: 'p95 (ms)',  data: p95  }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#cbd5e1' } } },
        scales: {
          x: { ticks: { color: '#cbd5e1' } },
          y: { ticks: { color: '#94a3b8' }, title: { display: true, text: 'ms' } }
        }
      }
    });
  } else {
    ctx.canvas.parentElement.insertAdjacentHTML(
      'beforeend',
      '<div class="text-sm text-slate-400 mt-2">No data to chart.</div>'
    );
  }
</script>
{% endblock %}
